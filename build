#!/bin/bash

#rm -rf "tmp"

set -uo pipefail
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR

LOCAL_PATH=/var/cache/pacman/pkg
REPO_NAME=custom

PACKAGES=${@:-pkg/*}

for package in $PACKAGES; do
    if [[ ! -f "$package/PKGBUILD" ]]; then
        echo "$package/PKGBUILD missing.
Make sure submodules are there:
    git submodule update --init --recursive
    git submodule foreach git pull origin master" >&2
        exit 1
    fi
done

CHROOT="$PWD/tmp"

mkdir -p "$LOCAL_PATH"
mkdir -p "$CHROOT"

[[ -d "$CHROOT/root" ]] || mkarchroot -C /etc/pacman.conf "$CHROOT/root" base base-devel git unzip meson cmake clojure

for package in $PACKAGES; do
    cd "$package"
    echo $(pwd) && ls PKGBUILD
    makechrootpkg -cur $CHROOT
    pkgs=*.pkg.tar.xz
    for pkg in $pkgs
    do
        mv $PWD/$pkg $LOCAL_PATH
        repo-add "$LOCAL_PATH/$REPO_NAME.db.tar.gz" $LOCAL_PATH/$pkg
    done
    cd -
done

ln -sf "$REPO_NAME.db.tar.gz" "$LOCAL_PATH/$REPO_NAME.db"
ln -sf "$REPO_NAME.files.tar.gz" "$LOCAL_PATH/$REPO_NAME.files"

