#!/bin/bash

rm -rf "root"

git pull --recurse-submodules

set -uo pipefail
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR

LOCAL_PATH=/var/cache/pacman/pkg
REPO_NAME=custom

PACKAGES=${@:-pkg/*}
CHROOT="$PWD/root"

mkdir -p "$LOCAL_PATH"
mkdir -p "$CHROOT"

[[ -d "$CHROOT/root" ]] || mkarchroot -C /etc/pacman.conf "$CHROOT/root" base base-devel git unzip

for package in $PACKAGES; do
    cd "$package"
    makechrootpkg -cur $CHROOT
    pkgs=*.pkg.tar.xz
    for pkg in $pkgs
    do
        mv $PWD/$pkg $LOCAL_PATH
        repo-add "$LOCAL_PATH/$REPO_NAME.db.tar.gz" $LOCAL_PATH/$pkg
    done
    cd -
done

ln -sf "$REPO_NAME.db.tar.gz" "$LOCAL_PATH/$REPO_NAME.db"
ln -sf "$REPO_NAME.files.tar.gz" "$LOCAL_PATH/$REPO_NAME.files"

